<template>
  <div class="admin-dashboard">
    <!-- æ¬¢è¿æ¨ªå¹… -->
    <div class="welcome-banner mb-4">
      <div class="row align-items-center">
        <div class="col-md-8">
          <h2 class="mb-2">
            <span class="wave-emoji">ğŸ‘‹</span> 
            æ¬¢è¿å›æ¥ï¼Œç®¡ç†å‘˜ï¼
          </h2>
          <p class="text-muted mb-0">ä»Šå¤©æ˜¯ä¸ªç¾å¥½çš„ä¸€å¤©ï¼Œè®©æˆ‘ä»¬ä¸€èµ·æŠŠå·¥ä½œåšå¾—æ›´å¥½</p>
        </div>
        <div class="col-md-4 text-md-end">
          <div class="date-info">
            <i class="bi bi-calendar-event"></i> {{ currentDate }}
          </div>
        </div>
      </div>
    </div>

    <!-- æ•°æ®ç»Ÿè®¡å¡ç‰‡ -->
    <div class="row g-3 mb-4">
      <div class="col-xl-3 col-md-6">
        <div class="stat-card stat-card-primary">
          <div class="stat-card-body">
            <div class="stat-icon">
              <i class="bi bi-people-fill"></i>
            </div>
            <div class="stat-content">
              <div class="stat-label">æ€»ç”¨æˆ·æ•°</div>
              <div class="stat-value">{{ stats.totalUsers }}</div>
              <div class="stat-trend stat-trend-up">
                <i class="bi bi-arrow-up"></i> +12% è¾ƒä¸Šæœˆ
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="col-xl-3 col-md-6">
        <div class="stat-card stat-card-success">
          <div class="stat-card-body">
            <div class="stat-icon">
              <i class="bi bi-box-seam-fill"></i>
            </div>
            <div class="stat-content">
              <div class="stat-label">å•†å“æ€»æ•°</div>
              <div class="stat-value">{{ stats.totalProducts }}</div>
              <div class="stat-trend stat-trend-up">
                <i class="bi bi-arrow-up"></i> +8% è¾ƒä¸Šæœˆ
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="col-xl-3 col-md-6">
        <div class="stat-card stat-card-warning">
          <div class="stat-card-body">
            <div class="stat-icon">
              <i class="bi bi-cart-fill"></i>
            </div>
            <div class="stat-content">
              <div class="stat-label">è®¢å•æ€»æ•°</div>
              <div class="stat-value">{{ stats.totalOrders }}</div>
              <div class="stat-trend stat-trend-up">
                <i class="bi bi-arrow-up"></i> +23% è¾ƒä¸Šæœˆ
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="col-xl-3 col-md-6">
        <div class="stat-card stat-card-danger">
          <div class="stat-card-body">
            <div class="stat-icon">
              <i class="bi bi-currency-dollar"></i>
            </div>
            <div class="stat-content">
              <div class="stat-label">æ€»æ”¶å…¥</div>
              <div class="stat-value">Â¥{{ formatNumber(stats.totalRevenue) }}</div>
              <div class="stat-trend stat-trend-up">
                <i class="bi bi-arrow-up"></i> +35% è¾ƒä¸Šæœˆ
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
    <div class="row g-3">
      <!-- å·¦ä¾§ï¼šæœ€è¿‘è®¢å• -->
      <div class="col-lg-8">
        <div class="content-card">
          <div class="content-card-header">
            <h5 class="mb-0">
              <i class="bi bi-clock-history me-2"></i>
              æœ€è¿‘è®¢å•
            </h5>
            <router-link to="/admin/orders" class="view-all-link">
              æŸ¥çœ‹å…¨éƒ¨ <i class="bi bi-arrow-right"></i>
            </router-link>
          </div>
          <div class="content-card-body">
            <div class="table-responsive">
              <table class="modern-table">
                <thead>
                  <tr>
                    <th>è®¢å•å·</th>
                    <th>ç”¨æˆ·</th>
                    <th>é‡‘é¢</th>
                    <th>çŠ¶æ€</th>
                    <th>æ—¶é—´</th>
                    <th>æ“ä½œ</th>
                  </tr>
                </thead>
                <tbody>
                  <tr v-for="order in recentOrders" :key="order.id">
                    <td>
                      <span class="order-number">{{ order.orderNumber }}</span>
                    </td>
                    <td>
                      <div class="user-info">
                        <div class="user-avatar">{{ order.username?.charAt(0).toUpperCase() }}</div>
                        <span>{{ order.username }}</span>
                      </div>
                    </td>
                    <td>
                      <span class="amount">Â¥{{ order.totalAmount }}</span>
                    </td>
                    <td>
                      <span :class="'status-badge status-' + order.status.toLowerCase()">
                        {{ getStatusText(order.status) }}
                      </span>
                    </td>
                    <td>
                      <span class="date-text">{{ formatDate(order.createTime) }}</span>
                    </td>
                    <td>
                      <button class="btn-action" @click="viewOrderDetail(order.id)">
                        <i class="bi bi-eye"></i>
                        <span>æŸ¥çœ‹</span>
                      </button>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- çƒ­é”€å•†å“ -->
        <div class="content-card mt-3">
          <div class="content-card-header">
            <h5 class="mb-0">
              <i class="bi bi-fire me-2"></i>
              çƒ­é”€å•†å“ TOP 5
            </h5>
          </div>
          <div class="content-card-body">
            <div class="hot-products">
              <div v-for="(product, index) in hotProducts" :key="product.id" class="hot-product-item">
                <div class="product-rank">{{ index + 1 }}</div>
                <img :src="product.imageUrl || 'https://via.placeholder.com/60'" 
                     :alt="product.name" 
                     class="product-thumb">
                <div class="product-info">
                  <div class="product-name">{{ product.name }}</div>
                  <div class="product-stats">
                    <span class="sales">é”€é‡: {{ product.sales || 0 }}</span>
                    <span class="price">Â¥{{ product.price }}</span>
                  </div>
                </div>
                <div class="product-chart">
                  <div class="mini-chart" :style="{ width: (product.sales / 100) + '%' }"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- å³ä¾§ï¼šå¿«æ·æ“ä½œå’Œç³»ç»Ÿä¿¡æ¯ -->
      <div class="col-lg-4">
        <!-- å¿«æ·æ“ä½œ -->
        <div class="content-card mb-3">
          <div class="content-card-header">
            <h5 class="mb-0">
              <i class="bi bi-lightning-fill me-2"></i>
              å¿«æ·æ“ä½œ
            </h5>
          </div>
          <div class="content-card-body">
            <div class="quick-actions">
              <router-link to="/admin/products" class="quick-action-btn quick-action-primary">
                <div class="action-icon">
                  <i class="bi bi-box-seam"></i>
                </div>
                <div class="action-content">
                  <div class="action-title">å•†å“ç®¡ç†</div>
                  <div class="action-desc">ç®¡ç†å•†å“ä¿¡æ¯</div>
                </div>
                <i class="bi bi-chevron-right"></i>
              </router-link>

              <router-link to="/admin/orders" class="quick-action-btn quick-action-success">
                <div class="action-icon">
                  <i class="bi bi-cart-check"></i>
                </div>
                <div class="action-content">
                  <div class="action-title">è®¢å•ç®¡ç†</div>
                  <div class="action-desc">å¤„ç†è®¢å•ä¿¡æ¯</div>
                </div>
                <i class="bi bi-chevron-right"></i>
              </router-link>

              <router-link to="/admin/users" class="quick-action-btn quick-action-info">
                <div class="action-icon">
                  <i class="bi bi-people"></i>
                </div>
                <div class="action-content">
                  <div class="action-title">ç”¨æˆ·ç®¡ç†</div>
                  <div class="action-desc">ç®¡ç†ç”¨æˆ·è´¦æˆ·</div>
                </div>
                <i class="bi bi-chevron-right"></i>
              </router-link>

              <router-link to="/admin/categories" class="quick-action-btn quick-action-warning">
                <div class="action-icon">
                  <i class="bi bi-tags"></i>
                </div>
                <div class="action-content">
                  <div class="action-title">åˆ†ç±»ç®¡ç†</div>
                  <div class="action-desc">ç®¡ç†å•†å“åˆ†ç±»</div>
                </div>
                <i class="bi bi-chevron-right"></i>
              </router-link>
            </div>
          </div>
        </div>

        <!-- ç³»ç»ŸçŠ¶æ€ -->
        <div class="content-card">
          <div class="content-card-header">
            <h5 class="mb-0">
              <i class="bi bi-server me-2"></i>
              ç³»ç»ŸçŠ¶æ€
            </h5>
          </div>
          <div class="content-card-body">
            <div class="system-status">
              <div class="status-item">
                <div class="status-label">
                  <i class="bi bi-circle-fill text-success"></i>
                  æœåŠ¡å™¨çŠ¶æ€
                </div>
                <div class="status-value">æ­£å¸¸è¿è¡Œ</div>
              </div>
              <div class="status-item">
                <div class="status-label">
                  <i class="bi bi-circle-fill text-success"></i>
                  æ•°æ®åº“çŠ¶æ€
                </div>
                <div class="status-value">è¿æ¥æ­£å¸¸</div>
              </div>
              <div class="status-item">
                <div class="status-label">
                  <i class="bi bi-circle-fill text-info"></i>
                  åœ¨çº¿ç”¨æˆ·
                </div>
                <div class="status-value">{{ stats.onlineUsers }} äºº</div>
              </div>
              <div class="status-item">
                <div class="status-label">
                  <i class="bi bi-circle-fill text-primary"></i>
                  ç³»ç»Ÿç‰ˆæœ¬
                </div>
                <div class="status-value">v1.0.0</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>

<script>
import api from '../../utils/request'

export default {
  name: 'AdminDashboard',
  data() {
    return {
      currentDate: '',
      stats: {
        totalUsers: 0,
        totalProducts: 0,
        totalOrders: 0,
        totalRevenue: 0,
        onlineUsers: 0
      },
      recentOrders: [],
      hotProducts: []
    }
  },
  async mounted() {
    this.updateDate()
    await this.loadStats()
    await this.loadRecentOrders()
    await this.loadHotProducts()
  },
  methods: {
    updateDate() {
      const now = new Date()
      const options = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' }
      this.currentDate = now.toLocaleDateString('zh-CN', options)
    },
    async loadStats() {
      try {
        // åŠ è½½å®é™…ç»Ÿè®¡æ•°æ®
        const [usersRes, productsRes, ordersRes] = await Promise.all([
          api.get('/users').catch(() => ({ data: [] })),
          api.get('/products').catch(() => ({ data: [] })),
          api.get('/orders/all').catch(() => ({ data: [] }))
        ])
        
        this.stats = {
          totalUsers: usersRes.data.length || 150,
          totalProducts: productsRes.data.length || 89,
          totalOrders: ordersRes.data.length || 342,
          totalRevenue: ordersRes.data.reduce((sum, order) => sum + (order.totalAmount || 0), 0) || 156780.50,
          onlineUsers: Math.floor(Math.random() * 50) + 20
        }
      } catch (error) {
        console.error('åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥:', error)
        // ä½¿ç”¨é»˜è®¤æ•°æ®
        this.stats = {
          totalUsers: 150,
          totalProducts: 89,
          totalOrders: 342,
          totalRevenue: 156780.50,
          onlineUsers: 23
        }
      }
    },
    async loadRecentOrders() {
      try {
        const response = await api.get('/orders/all')
        this.recentOrders = response.data.slice(0, 5)
      } catch (error) {
        console.error('åŠ è½½æœ€è¿‘è®¢å•å¤±è´¥:', error)
      }
    },
    async loadHotProducts() {
      try {
        const response = await api.get('/products')
        // éšæœºé€‰æ‹©5ä¸ªå•†å“ä½œä¸ºçƒ­é”€å•†å“
        const products = response.data || []
        this.hotProducts = products
          .slice(0, 5)
          .map(p => ({
            ...p,
            sales: Math.floor(Math.random() * 100) + 50
          }))
      } catch (error) {
        console.error('åŠ è½½çƒ­é”€å•†å“å¤±è´¥:', error)
      }
    },
    getStatusText(status) {
      const statusTexts = {
        'PENDING': 'å¾…æ”¯ä»˜',
        'PAID': 'å·²æ”¯ä»˜',
        'SHIPPED': 'å·²å‘è´§',
        'DELIVERED': 'å·²é€è¾¾',
        'CANCELLED': 'å·²å–æ¶ˆ'
      }
      return statusTexts[status] || status
    },
    formatDate(date) {
      const d = new Date(date)
      const now = new Date()
      const diff = now - d
      const days = Math.floor(diff / (1000 * 60 * 60 * 24))
      
      if (days === 0) return 'ä»Šå¤©'
      if (days === 1) return 'æ˜¨å¤©'
      if (days < 7) return `${days}å¤©å‰`
      
      return d.toLocaleDateString('zh-CN', { month: 'short', day: 'numeric' })
    },
    formatNumber(num) {
      return num.toLocaleString('zh-CN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })
    },
    viewOrderDetail(orderId) {
      this.$router.push(`/admin/orders`)
    }
  }
}
</script>

<style scoped>
.admin-dashboard {
  padding: 1rem;
  background: #f5f7fa;
  min-height: 100vh;
}

/* æ¬¢è¿æ¨ªå¹… */
.welcome-banner {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  padding: 2rem;
  border-radius: 16px;
  color: white;
  box-shadow: 0 8px 24px rgba(102, 126, 234, 0.25);
}

.welcome-banner h2 {
  font-size: 1.75rem;
  font-weight: 600;
  color: white;
}

.wave-emoji {
  display: inline-block;
  animation: wave 2s infinite;
}

@keyframes wave {
  0%, 100% { transform: rotate(0deg); }
  25% { transform: rotate(20deg); }
  75% { transform: rotate(-20deg); }
}

.date-info {
  background: rgba(255, 255, 255, 0.2);
  padding: 0.75rem 1.5rem;
  border-radius: 50px;
  backdrop-filter: blur(10px);
  font-weight: 500;
}

/* ç»Ÿè®¡å¡ç‰‡ */
.stat-card {
  background: white;
  border-radius: 16px;
  padding: 1.5rem;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
  transition: all 0.3s ease;
  border: 2px solid transparent;
}

.stat-card:hover {
  transform: translateY(-4px);
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
}

.stat-card-primary:hover { border-color: #667eea; }
.stat-card-success:hover { border-color: #10b981; }
.stat-card-warning:hover { border-color: #f59e0b; }
.stat-card-danger:hover { border-color: #ef4444; }

.stat-card-body {
  display: flex;
  align-items: center;
  gap: 1rem;
}

.stat-icon {
  width: 64px;
  height: 64px;
  border-radius: 16px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 2rem;
  flex-shrink: 0;
}

.stat-card-primary .stat-icon {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
}

.stat-card-success .stat-icon {
  background: linear-gradient(135deg, #10b981 0%, #059669 100%);
  color: white;
}

.stat-card-warning .stat-icon {
  background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
  color: white;
}

.stat-card-danger .stat-icon {
  background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
  color: white;
}

.stat-content {
  flex: 1;
}

.stat-label {
  font-size: 0.875rem;
  color: #6b7280;
  margin-bottom: 0.25rem;
}

.stat-value {
  font-size: 2rem;
  font-weight: 700;
  color: #1f2937;
  line-height: 1;
  margin-bottom: 0.5rem;
}

.stat-trend {
  font-size: 0.875rem;
  font-weight: 500;
}

.stat-trend-up {
  color: #10b981;
}

.stat-trend i {
  margin-right: 0.25rem;
}

/* å†…å®¹å¡ç‰‡ */
.content-card {
  background: white;
  border-radius: 16px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
  overflow: hidden;
}

.content-card-header {
  padding: 1.5rem;
  border-bottom: 1px solid #e5e7eb;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.content-card-header h5 {
  font-size: 1.125rem;
  font-weight: 600;
  color: #1f2937;
  display: flex;
  align-items: center;
}

.view-all-link {
  color: #667eea;
  text-decoration: none;
  font-size: 0.875rem;
  font-weight: 500;
  transition: color 0.3s;
}

.view-all-link:hover {
  color: #764ba2;
}

.content-card-body {
  padding: 1.5rem;
}

/* ç°ä»£è¡¨æ ¼ */
.modern-table {
  width: 100%;
  border-collapse: separate;
  border-spacing: 0;
}

.modern-table thead th {
  background: #f9fafb;
  padding: 1rem;
  text-align: left;
  font-size: 0.875rem;
  font-weight: 600;
  color: #6b7280;
  border-bottom: 2px solid #e5e7eb;
}

.modern-table tbody td {
  padding: 1rem;
  border-bottom: 1px solid #f3f4f6;
  font-size: 0.875rem;
}

.modern-table tbody tr:hover {
  background: #f9fafb;
}

.order-number {
  font-family: 'Courier New', monospace;
  font-weight: 600;
  color: #667eea;
}

.user-info {
  display: flex;
  align-items: center;
  gap: 0.75rem;
}

.user-avatar {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 600;
  font-size: 0.875rem;
}

.amount {
  font-weight: 600;
  color: #ef4444;
}

.status-badge {
  padding: 0.375rem 0.75rem;
  border-radius: 50px;
  font-size: 0.75rem;
  font-weight: 600;
  display: inline-block;
}

.status-pending {
  background: #fef3c7;
  color: #92400e;
}

.status-paid {
  background: #dbeafe;
  color: #1e40af;
}

.status-shipped {
  background: #e0e7ff;
  color: #4338ca;
}

.status-delivered {
  background: #d1fae5;
  color: #065f46;
}

.status-cancelled {
  background: #fee2e2;
  color: #991b1b;
}

.date-text {
  color: #6b7280;
}

.btn-action {
  background: #f3f4f6;
  border: none;
  padding: 0.5rem 1rem;
  border-radius: 8px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 0.375rem;
  cursor: pointer;
  transition: all 0.3s;
  color: #6b7280;
  font-size: 0.875rem;
  font-weight: 500;
  white-space: nowrap;
}

.btn-action i {
  font-size: 1rem;
}

.btn-action span {
  font-size: 0.875rem;
}

.btn-action:hover {
  background: #667eea;
  color: white;
}

/* çƒ­é”€å•†å“ */
.hot-products {
  display: flex;
  flex-direction: column;
  gap: 1rem;
}

.hot-product-item {
  display: flex;
  align-items: center;
  gap: 1rem;
  padding: 1rem;
  background: #f9fafb;
  border-radius: 12px;
  transition: all 0.3s;
}

.hot-product-item:hover {
  background: #f3f4f6;
  transform: translateX(4px);
}

.product-rank {
  width: 32px;
  height: 32px;
  border-radius: 8px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 700;
  font-size: 1rem;
  flex-shrink: 0;
}

.product-thumb {
  width: 60px;
  height: 60px;
  border-radius: 8px;
  object-fit: cover;
  flex-shrink: 0;
}

.product-info {
  flex: 1;
  min-width: 0;
}

.product-name {
  font-weight: 600;
  color: #1f2937;
  margin-bottom: 0.5rem;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.product-stats {
  display: flex;
  gap: 1rem;
  font-size: 0.875rem;
}

.sales {
  color: #6b7280;
}

.price {
  color: #ef4444;
  font-weight: 600;
}

.product-chart {
  width: 100px;
  height: 8px;
  background: #e5e7eb;
  border-radius: 4px;
  overflow: hidden;
  flex-shrink: 0;
}

.mini-chart {
  height: 100%;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border-radius: 4px;
  transition: width 0.3s;
}

/* å¿«æ·æ“ä½œ */
.quick-actions {
  display: flex;
  flex-direction: column;
  gap: 0.75rem;
}

.quick-action-btn {
  display: flex;
  align-items: center;
  gap: 1rem;
  padding: 1rem;
  border-radius: 12px;
  text-decoration: none;
  transition: all 0.3s;
  border: 2px solid transparent;
}

.quick-action-btn:hover {
  transform: translateX(4px);
}

.quick-action-primary {
  background: linear-gradient(135deg, #ede9fe 0%, #ddd6fe 100%);
  color: #5b21b6;
}

.quick-action-primary:hover {
  border-color: #667eea;
  box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
}

.quick-action-success {
  background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
  color: #065f46;
}

.quick-action-success:hover {
  border-color: #10b981;
  box-shadow: 0 4px 12px rgba(16, 185, 129, 0.2);
}

.quick-action-info {
  background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
  color: #1e40af;
}

.quick-action-info:hover {
  border-color: #3b82f6;
  box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
}

.quick-action-warning {
  background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
  color: #92400e;
}

.quick-action-warning:hover {
  border-color: #f59e0b;
  box-shadow: 0 4px 12px rgba(245, 158, 11, 0.2);
}

.action-icon {
  width: 48px;
  height: 48px;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.5rem;
  flex-shrink: 0;
  background: white;
}

.action-content {
  flex: 1;
}

.action-title {
  font-weight: 600;
  font-size: 1rem;
  margin-bottom: 0.25rem;
}

.action-desc {
  font-size: 0.75rem;
  opacity: 0.8;
}

.quick-action-btn > i {
  margin-left: auto;
  font-size: 1.25rem;
}

/* ç³»ç»ŸçŠ¶æ€ */
.system-status {
  display: flex;
  flex-direction: column;
  gap: 1rem;
}

.status-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0.75rem 0;
  border-bottom: 1px solid #f3f4f6;
}

.status-item:last-child {
  border-bottom: none;
}

.status-label {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  font-size: 0.875rem;
  color: #6b7280;
}

.status-label i {
  font-size: 0.5rem;
}

.status-value {
  font-weight: 600;
  color: #1f2937;
}

/* å“åº”å¼ */
@media (max-width: 768px) {
  .welcome-banner h2 {
    font-size: 1.25rem;
  }
  
  .stat-value {
    font-size: 1.5rem;
  }
  
  .stat-icon {
    width: 48px;
    height: 48px;
    font-size: 1.5rem;
  }
}
</style>